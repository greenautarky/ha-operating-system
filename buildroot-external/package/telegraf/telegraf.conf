###############################################################################
# Telegraf minimal config for iHost / HAOS
# Goal: low resource usage, essential host + Docker metrics
###############################################################################

[agent]
  interval = "15s"                # relaxed interval to reduce load
  round_interval = true
  metric_batch_size = 500
  metric_buffer_limit = 100000    # ~8 hours buffer when output is unreachable
  collection_jitter = "2s"        # avoids spikes
  flush_interval = "15s"
  flush_jitter = "2s"
  logfile = ""
  quiet = false
  omit_hostname = true            # hostname is always "kibu", use uuid/device_label instead

[global_tags]
  env = "${GA_ENV}"
  device_type = "ihost"
  uuid = "${DEVICE_UUID}"
  device_label = "${DEVICE_LABEL}"

###############################################################################
# INPUTS - ESSENTIAL HOST METRICS
###############################################################################

# CPU usage (total only — per-cpu is noisy on 4-core devices)
[[inputs.cpu]]
  percpu = false
  totalcpu = true
  collect_cpu_time = false
  report_active = true

# Memory usage
[[inputs.mem]]

# Swap usage (in case swap is enabled)
[[inputs.swap]]

# System uptime + load average
[[inputs.system]]

# Disk usage (limit to relevant mounts to avoid noise)
[[inputs.disk]]
  mount_points = ["/", "/mnt/data"]
  ignore_fs = ["tmpfs", "devtmpfs", "overlay"]

# Network I/O (eth0/end0 varies by device, wt0 = NetBird)
[[inputs.net]]
  interfaces = ["eth0", "end0", "wt0"]
  ignore_protocol_stats = true

###############################################################################
# INPUTS - DOCKER METRICS (Home Assistant, Add-ons, etc.)
###############################################################################

# Requires access to the Docker socket
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  perdevice = false               # disable per-device details to stay lean
  total = true                    # only aggregate where possible
  gather_services = false
  container_name_include = []     # include all containers by default
  container_name_exclude = ["telegraf"]  # do not monitor itself
  timeout = "5s"

###############################################################################
# INPUTS - NETWORK CONNECTIVITY
###############################################################################

# Ping gateway + internet to detect connectivity issues
# GATEWAY_IP is auto-detected at boot from default route
[[inputs.ping]]
  urls = ["${GATEWAY_IP}", "1.1.1.1", "8.8.8.8"]
  method = "native"
  count = 3
  ping_interval = 1.0
  timeout = 4.0

###############################################################################
# INPUTS - BOOT TIMING
###############################################################################

# Report boot milestones to InfluxDB (static per boot, collected once per hour)
[[inputs.exec]]
  commands = ["/usr/libexec/ga-boot-timing"]
  timeout = "10s"
  interval = "1h"
  data_format = "influx"

###############################################################################
# OUTPUTS
###############################################################################

# Central InfluxDB (via NetBird)
[[outputs.influxdb]]
  urls = ["http://influx.greenautarky.com:8086"]
  database = "device_metrics"
  username = "device_writer"
  password = "FzvXhbV8SMDrKhHgcEyYbZvEtVpZ5XX1"
  precision = "s"
  timeout = "5s"

# Local InfluxDB (via Tailscale) — disabled until available
#[[outputs.influxdb]]
#  urls = ["http://influxdb:8086"]
#  database = "device_metrics"
#  precision = "s"
#  timeout = "5s"
