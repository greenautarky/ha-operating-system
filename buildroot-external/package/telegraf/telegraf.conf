###############################################################################
# Telegraf minimal config for iHost / HAOS
# Goal: low resource usage, essential host + Docker metrics, write to local InfluxDB
###############################################################################

[agent]
  interval = "15s"                # relaxed interval to reduce load
  round_interval = true
  metric_batch_size = 500
  metric_buffer_limit = 2000
  collection_jitter = "2s"        # avoids spikes
  flush_interval = "15s"
  flush_jitter = "2s"
  logfile = ""
  quiet = false
  omit_hostname = false           # use hostname as tag to distinguish devices

###############################################################################
# INPUTS - ESSENTIAL HOST METRICS
###############################################################################

# CPU usage (per CPU + total)
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = true

# Memory usage
[[inputs.mem]]

# Swap usage (in case swap is enabled)
[[inputs.swap]]

# Disk usage (limit to relevant mounts to avoid noise)
[[inputs.disk]]
  mount_points = ["/", "/mnt/data"]
  ignore_fs = ["tmpfs", "devtmpfs", "overlay"]

# Basic network I/O (adjust interface name if needed)
[[inputs.net]]
  interfaces = ["eth0"]
  ignore_protocol_stats = true

###############################################################################
# INPUTS - DOCKER METRICS (Home Assistant, Add-ons, etc.)
###############################################################################

# Requires access to the Docker socket inside the container/add-on
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  perdevice = false               # disable per-device details to stay lean
  total = true                    # only aggregate where possible
  gather_services = false
  container_name_include = []     # include all containers by default
  container_name_exclude = ["telegraf"]  # do not monitor itself
  timeout = "5s"

###############################################################################
# OUTPUT - LOCAL INFLUXDB (InfluxDB 1.x style)
###############################################################################

[[outputs.influxdb]]
  urls = ["http://influxdb:8086"] # set to your InfluxDB (service name or IP)
  database = "device_metrics"
  precision = "s"
  timeout = "5s"
  write_consistency = "any"

[[outputs.influxdb]]
  urls = ["http://influxdb.greenautarky.com:8086"] # set to your InfluxDB (service name or IP)
  database = "device_metrics"
  precision = "s"
  timeout = "5s"
  write_consistency = "any"