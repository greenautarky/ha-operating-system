[SERVICE]
    Flush        5
    Daemon       off
    Log_Level    info
    Parsers_File parsers.conf
    # Persistent buffering on device (store & forward)
    storage.path              /mnt/data/fluent-bit/storage
    storage.sync              normal
    storage.checksum          on
    storage.backlog.mem_limit 5M

# --- INPUTS ----------------------------------------------------------
# 1) Systemd: only selected critical units to keep volume low
[INPUT]
    Name              systemd
    Tag               ihost.systemd
    Read_From_Tail    true
    storage.type      filesystem
    # Keep it focused: adjust units to your build
    Systemd_Filter    _SYSTEMD_UNIT=network.service
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Systemd_Filter    _SYSTEMD_UNIT=home-assistant.service
    Systemd_Filter    _SYSTEMD_UNIT=supervisor.service
    Systemd_Filter    _SYSTEMD_UNIT=netbird.service

# 2) Home Assistant core log
[INPUT]
    Name              tail
    Tag               ihost.hass
    Path              /mnt/data/supervisor/logs/homeassistant.log
    DB                /mnt/data/fluent-bit/db/homeassistant.db
    Mem_Buf_Limit     5M
    Skip_Long_Lines   On
    storage.type      filesystem

# 3) Supervisor log
[INPUT]
    Name              tail
    Tag               ihost.supervisor
    Path              /mnt/data/supervisor/logs/supervisor.log
    DB                /mnt/data/fluent-bit/db/supervisor.db
    Mem_Buf_Limit     2M
    Skip_Long_Lines   On
    storage.type      filesystem

# (Optional) Kernel / generic syslog if available on your build:
#[INPUT]
#    Name              tail
#    Tag               ihost.syslog
#    Path              /var/log/messages
#    DB                /mnt/data/fluent-bit/db/syslog.db
#    Mem_Buf_Limit     2M
#    Skip_Long_Lines   On
#    storage.type      filesystem

# --- FILTERS ---------------------------------------------------------
# Add metadata so many devices are distinguishable in the backend
[FILTER]
    Name          record_modifier
    Match         ihost.*
    Record        host ${HOSTNAME}
    Record        device_type ihost
    Record        env ${GA_ENV}

# Optional: drop super noisy stuff (example)
#[FILTER]
#    Name      grep
#    Match     ihost.systemd
#    Exclude   MESSAGE   "Health check failed"

# --- OUTPUTS ---------------------------------------------------------
# Send everything to a central Fluent Bit / log-gateway using forward protocol
#[OUTPUT]
#    Name                    forward
#    Match                   ihost.*
#    Host                    log-gateway.local      # set this to your central collector
#    Port                    24224
#    Retry_Limit             False                  # infinite retries
#    net.keepalive           On
#    net.connect_timeout     5
#    net.retry_timeout       10
#    storage.total_limit_size 200M                  # max on-disk queue for this output


# Send to central Loki (primary)
[OUTPUT]
    Name          loki
    Match         ihost.*
    Host          loki.greenautarky.com
    Port          3100
    URI           /loki/api/v1/push
    labels        job=ihost,hostname=${HOSTNAME},uuid=${DEVICE_UUID},env=${GA_ENV}
    line_format   json
    drop_single_key On
    Retry_Limit   False
    storage.total_limit_size 200M

# Send to central Loki (fallback)
[OUTPUT]
    Name          loki
    Match         ihost.*
    Host          loki-alt.greenautarky.com
    Port          3100
    URI           /loki/api/v1/push
    labels        job=ihost,hostname=${HOSTNAME},uuid=${DEVICE_UUID},env=${GA_ENV}
    line_format   json
    drop_single_key On
    Retry_Limit   False
    storage.total_limit_size 200M

